<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Engineering Vision | النظام الذكي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #1e40af; --bg: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); padding: 10px; }
        .glass-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .grid-table { display: grid; grid-template-columns: 0.8fr repeat(5, 1fr); gap: 2px; }
        .header-pill { background: var(--primary); color: white; padding: 5px; text-align: center; font-size: 10px; font-weight: bold; border-radius: 4px; }
        .cell-base { border-radius: 4px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #f1f5f9; position: relative; }
        .time-cell { background: #f1f5f9; color: var(--primary); font-weight: bold; font-size: 9px; }
        .course-card { width: 100%; height: 100%; text-align: center; display: flex; flex-direction: column; justify-content: center; border-radius: 4px; }
        .day-btn { flex: 1; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .day-btn.active { background: #10b981; color: white; border-color: #10b981; }
    </style>
</head>
<body>

<div class="max-w-4xl mx-auto space-y-4">
    <div class="glass-card space-y-4 no-print">
        <h2 class="text-center font-black text-blue-800 italic">ENGINEERING VISION AI</h2>
        
        <div class="rounded-xl overflow-hidden border-2 border-dashed border-blue-200">
            <iframe src="https://gu4jjgetwkwmtfdvutaupn.streamlit.app/?embed=true" width="100%" height="250" frameborder="0"></iframe>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <input id="courseName" type="text" placeholder="اسم المادة" class="p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:ring-2 ring-blue-400">
            <input id="roomName" type="text" placeholder="القاعة" class="p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:ring-2 ring-blue-400">
        </div>

        <div class="flex gap-1" id="daySelector">
            <button class="day-btn" onclick="toggleDay(0, this)">أحد</button>
            <button class="day-btn" onclick="toggleDay(1, this)">اثنين</button>
            <button class="day-btn" onclick="toggleDay(2, this)">ثلاثاء</button>
            <button class="day-btn" onclick="toggleDay(3, this)">أربعاء</button>
            <button class="day-btn" onclick="toggleDay(4, this)">خميس</button>
        </div>

        <div id="daysConfigs" class="grid grid-cols-1 gap-2"></div>

        <button onclick="saveEntry()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-100">إضافة للجدول</button>
    </div>

    <div id="capture-area" class="glass-card">
        <div id="grid-container" class="grid-table"></div>
    </div>
</div>

<script>
    const TIME_SLOTS = [
        { id: "54", s: "07:15", e: "08:05" }, { id: "86", s: "08:15", e: "09:05" },
        { id: "44", s: "09:15", e: "10:05" }, { id: "80", s: "10:15", e: "11:05" },
        { id: "47", s: "12:15", e: "01:05" }, { id: "63", s: "01:15", e: "02:05" },
        { id: "52", s: "02:15", e: "03:05" }, { id: "51", s: "03:15", e: "04:05" }
    ];
    const DAYS_NAMES = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس"];
    let scheduleData = JSON.parse(localStorage.getItem("ev_ai_v1")) || [];
    let currentSelectedDays = new Map();

    // استقبال البيانات من تطبيق بايثون
    window.addEventListener('message', function(event) {
        if (event.data.type === 'ocr_result') {
            const slots = event.data.slots;
            // تفعيل يوم الأحد كافتراضي للفترات المستخرجة
            let dayIdx = 0; 
            if (!currentSelectedDays.has(dayIdx)) {
                currentSelectedDays.set(dayIdx, new Set());
                document.querySelectorAll('.day-btn')[dayIdx].classList.add('active');
            }
            slots.forEach(id => currentSelectedDays.get(dayIdx).add(id));
            renderConfigs();
        }
    });

    function toggleDay(idx, el) {
        if(currentSelectedDays.has(idx)) {
            currentSelectedDays.delete(idx);
            el.classList.remove("active");
        } else {
            currentSelectedDays.set(idx, new Set());
            el.classList.add("active");
        }
        renderConfigs();
    }

    function renderConfigs() {
        const container = document.getElementById("daysConfigs");
        container.innerHTML = "";
        currentSelectedDays.forEach((slots, dayIdx) => {
            container.innerHTML += `<div class="p-2 bg-blue-50 rounded-lg">
                <p class="text-[10px] font-bold text-blue-600 mb-1">${DAYS_NAMES[dayIdx]}</p>
                <div class="grid grid-cols-4 gap-1">
                    ${TIME_SLOTS.map(t => `<button onclick="toggleTime(${dayIdx},'${t.id}',this)" class="text-[10px] p-1 border rounded ${slots.has(t.id)?'bg-blue-600 text-white':'bg-white'}">${t.id}</button>`).join('')}
                </div>
            </div>`;
        });
    }

    function toggleTime(dayIdx, id, el) {
        const set = currentSelectedDays.get(dayIdx);
        set.has(id) ? set.delete(id) : set.add(id);
        renderConfigs();
    }

    function renderTable() {
        const container = document.getElementById("grid-container");
        container.innerHTML = `<div class="header-pill">الوقت</div>` + DAYS_NAMES.map(d => `<div class="header-pill">${d}</div>`).join("");
        TIME_SLOTS.forEach(slot => {
            container.innerHTML += `<div class="cell-base time-cell"><div>${slot.s}</div></div>`;
            for (let d = 0; d < 5; d++) {
                const entry = scheduleData.find(x => x.day == d && x.slotId === slot.id);
                if (entry) {
                    container.innerHTML += `<div class="cell-base" style="background:#eff6ff; border:1px solid #bfdbfe">
                        <div class="course-card"><div style="font-size:8px; font-weight:900">${entry.name}</div></div>
                    </div>`;
                } else {
                    container.innerHTML += `<div class="cell-base"></div>`;
                }
            }
        });
    }

    function saveEntry() {
        const name = document.getElementById("courseName").value;
        if (!name || currentSelectedDays.size === 0) return alert("أكمل البيانات");
        currentSelectedDays.forEach((slots, dayIdx) => {
            slots.forEach(id => {
                scheduleData = scheduleData.filter(x => !(x.day == dayIdx && x.slotId === id));
                scheduleData.push({ day: dayIdx, slotId: id, name: name });
            });
        });
        localStorage.setItem("ev_ai_v1", JSON.stringify(scheduleData));
        location.reload();
    }

    renderTable();
</script>
</body>
</html>
