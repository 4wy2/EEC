<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Engineering Vision | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        :root { --primary: #1e40af; --secondary: #10b981; --bg: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding: 20px; }
        
        .glass-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; overflow: hidden; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ */
        .grid-table { display: grid; grid-template-columns: 0.8fr repeat(5, 1fr); gap: 4px; background: #fff; }
        .header-pill { background: var(--primary); color: white; padding: 10px 2px; font-weight: 700; font-size: 12px; text-align: center; border-radius: 4px; }
        
        .cell-base { border-radius: 6px; min-height: 65px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
        .time-cell { background: #f8fafc; font-weight: 800; font-size: 11px; color: var(--primary); border: 1px solid #e2e8f0; }
        
        .course-card { width: 100%; height: 100%; padding: 5px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .c-name { font-weight: 900; font-size: 10px; line-height: 1.2; }
        .c-room { font-size: 9px; font-weight: 600; opacity: 0.8; margin-top: 2px; }
        
        .delete-btn { position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 20; }
        .cell-base:hover .delete-btn { display: flex; }
        .cell-base:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Ø§Ù„ØªØ­ÙƒÙ… */
        .day-btn { padding: 10px; background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; flex: 1; text-align: center; }
        .day-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); transform: translateY(-2px); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingOverlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .glass-card { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner mb-4"></div>
    <h2 class="text-xl font-black text-blue-900">Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</h2>
    <p class="text-gray-500 font-bold">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«ÙˆØ§Ù†ÙŠ Ù‚Ù„ÙŠÙ„Ø©</p>
</div>

<div class="max-w-6xl mx-auto">
    <div class="glass-card p-6 mb-8 no-print border-t-4 border-t-blue-600">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
            <div class="text-center md:text-right">
                <h1 class="text-3xl font-black text-blue-900 italic">ENGINEERING VISION</h1>
                <p class="text-emerald-600 font-bold tracking-widest text-sm">SCIENTIFIC COMMITTEE â€¢ ÙƒÙ„ÙŠÙ€Ø© Ø§Ù„Ù‡Ù†Ø¯Ø³Ù€Ø©</p>
            </div>
            
            <div class="flex flex-col items-center gap-2">
                <input type="file" id="imageInput" accept="image/*,application/pdf" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-3 shadow-xl shadow-emerald-100 transition-all active:scale-95">
                    <span>Ù‚Ø±Ø§Ø¡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† ØµÙˆØ±Ø© ğŸ“¸</span>
                </button>
                <span class="text-[10px] text-gray-400 font-bold italic">ÙŠØ¯Ø¹Ù… ØµÙˆØ± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø¬Ø§Ù…Ø¹Ø©</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="space-y-2">
                <label class="text-xs font-black text-gray-400 px-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <input id="courseName" type="text" placeholder="Ù…Ø«Ø§Ù„: MATH 201" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 ring-blue-500 font-bold transition-all">
            </div>
            <div class="space-y-2">
                <label class="text-xs font-black text-gray-400 px-1">Ø§Ù„Ù‚Ø§Ø¹Ø© / Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
                <input id="roomName" type="text" placeholder="Ù…Ø«Ø§Ù„: Bldg 2 - G40" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 ring-blue-500 font-bold transition-all">
            </div>
        </div>

        <div class="mb-6">
            <label class="text-xs font-black text-gray-400 block mb-3 px-1">Ø§Ø®ØªØ± Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:</label>
            <div class="flex gap-2" id="daySelector">
                <button class="day-btn" onclick="toggleDay(0, this)">Ø£Ø­Ø¯</button>
                <button class="day-btn" onclick="toggleDay(1, this)">Ø§Ø«Ù†ÙŠÙ†</button>
                <button class="day-btn" onclick="toggleDay(2, this)">Ø«Ù„Ø§Ø«Ø§Ø¡</button>
                <button class="day-btn" onclick="toggleDay(3, this)">Ø£Ø±Ø¨Ø¹Ø§Ø¡</button>
                <button class="day-btn" onclick="toggleDay(4, this)">Ø®Ù…ÙŠØ³</button>
            </div>
        </div>

        <div id="daysConfigs" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3 mb-8"></div>

        <div class="flex flex-wrap gap-3 border-t pt-6">
            <button onclick="saveEntry()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-blue-100 transition-all">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„</button>
            <button onclick="downloadPDF()" class="px-10 bg-gray-900 text-white rounded-2xl font-bold hover:bg-black transition-all">Ø­ÙØ¸ PDF</button>
            <button onclick="resetAll()" class="px-6 bg-red-50 text-red-500 rounded-2xl font-bold hover:bg-red-100 transition-all">ØªØµÙÙŠØ© Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>

    <div id="capture-area" class="glass-card p-6 bg-white">
        <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-4">
            <div>
                <h2 class="text-2xl font-black text-blue-900">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</h2>
                <p class="text-xs font-bold text-gray-500">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Engineering Vision Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
            <div class="text-left">
                <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Scientific Committee</p>
                <p class="text-[10px] font-bold text-gray-400 italic" id="pdfDate"></p>
            </div>
        </div>

        <div id="grid-container" class="grid-table">
            </div>
        
        <div class="mt-6 text-center border-t pt-4">
            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">Official Academic Schedule â€¢ Faculty of Engineering</p>
        </div>
    </div>
</div>

<script>
    const TIME_SLOTS = [
        { id: "54", s: "07:15", e: "08:05" }, { id: "86", s: "08:15", e: "09:05" },
        { id: "44", s: "09:15", e: "10:05" }, { id: "80", s: "10:15", e: "11:05" },
        { id: "47", s: "12:15", e: "01:05" }, { id: "63", s: "01:15", e: "02:05" },
        { id: "52", s: "02:15", e: "03:05" }, { id: "51", s: "03:15", e: "04:05" }
    ];
    const DAYS_NAMES = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];
    
    document.getElementById('pdfDate').innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: " + new Date().toLocaleDateString('ar-SA');

    let scheduleData = JSON.parse(localStorage.getItem("ev_final_pro")) || [];
    let currentSelectedDays = new Map();
    let courseColors = JSON.parse(localStorage.getItem("ev_colors_pro")) || {};

    // --- Ø®Ø§ØµÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (OCR) ---
    document.getElementById('imageInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('loadingOverlay').style.display = 'flex';
        
        try {
            const worker = await Tesseract.createWorker('eng'); // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØºØ§Ù„Ø¨Ø§Ù‹ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            
            parseAI(text);
        } catch (err) {
            alert("ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©.");
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    });

    function parseAI(text) {
        const lines = text.split('\n');
        lines.forEach(line => {
            const periods = line.match(/\b(44|47|51|52|54|63|80|86)\b/g);
            const courseMatch = line.match(/[A-Z]{2,}\s?\d{3}/);

            if (periods && courseMatch) {
                const name = courseMatch[0];
                const color = getColor(name);
                
                periods.forEach(p => {
                    // ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø³Ø·Ø± (Ù…Ù†Ø·Ù‚ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù†Ø³Ù‚Ø©)
                    let dayIdx = estimateDayIdx(line, p);
                    
                    scheduleData = scheduleData.filter(x => !(x.day == dayIdx && x.slotId === p));
                    scheduleData.push({ day: dayIdx, slotId: p, name, room: "AI Detected", color });
                });
            }
        });
        updateUI();
    }

    function estimateDayIdx(line, p) {
        const pos = line.indexOf(p);
        const rel = pos / line.length;
        if (rel < 0.35) return 0; // Ø£Ø­Ø¯
        if (rel < 0.55) return 1; // Ø§Ø«Ù†ÙŠÙ†
        if (rel < 0.75) return 2; // Ø«Ù„Ø§Ø«Ø§Ø¡
        return 3; // Ø£Ø±Ø¨Ø¹Ø§Ø¡ Ø£Ùˆ Ø®Ù…ÙŠØ³
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    function getColor(name) {
        if (courseColors[name]) return courseColors[name];
        const hue = Math.floor(Math.random() * 360);
        courseColors[name] = {
            bg: `hsl(${hue}, 85%, 97%)`,
            border: `hsl(${hue}, 50%, 85%)`,
            text: `hsl(${hue}, 90%, 20%)`
        };
        localStorage.setItem("ev_colors_pro", JSON.stringify(courseColors));
        return courseColors[name];
    }

    function toggleDay(idx, el) {
        if(currentSelectedDays.has(idx)) {
            currentSelectedDays.delete(idx);
            el.classList.remove("active");
        } else {
            currentSelectedDays.set(idx, new Set());
            el.classList.add("active");
        }
        renderConfigs();
    }

    function toggleTime(dayIdx, slotId, el) {
        const slots = currentSelectedDays.get(dayIdx);
        if(slots.has(slotId)) {
            slots.delete(slotId);
            el.classList.remove("bg-blue-600", "text-white");
        } else {
            slots.add(slotId);
            el.classList.add("bg-blue-600", "text-white");
        }
    }

    function renderConfigs() {
        const container = document.getElementById("daysConfigs");
        container.innerHTML = "";
        currentSelectedDays.forEach((slots, dayIdx) => {
            container.innerHTML += `
                <div class="bg-white p-3 rounded-xl border-2 border-blue-50">
                    <p class="text-xs font-black text-blue-700 mb-2">${DAYS_NAMES[dayIdx]}</p>
                    <div class="grid grid-cols-4 gap-1">
                        ${TIME_SLOTS.map(t => `<button onclick="toggleTime(${dayIdx}, '${t.id}', this)" class="text-[9px] py-1 border rounded font-bold transition-all ${slots.has(t.id) ? 'bg-blue-600 text-white' : 'bg-gray-50'}">${t.id}</button>`).join("")}
                    </div>
                </div>`;
        });
    }

    function renderTable() {
        const container = document.getElementById("grid-container");
        container.innerHTML = `<div class="header-pill">Ø§Ù„ÙØªØ±Ø©</div>` + DAYS_NAMES.map(d => `<div class="header-pill">${d}</div>`).join("");

        TIME_SLOTS.forEach(slot => {
            container.innerHTML += `
                <div class="cell-base time-cell">
                    <span class="text-blue-900">${slot.s}</span>
                    <span class="opacity-40 text-[8px] tracking-tighter">${slot.e}</span>
                    <span class="absolute bottom-0 right-1 text-[7px] opacity-20">${slot.id}</span>
                </div>`;
            
            for (let d = 0; d < 5; d++) {
                const entry = scheduleData.find(x => x.day == d && x.slotId === slot.id);
                if (!entry) {
                    container.innerHTML += `<div class="cell-base"></div>`;
                } else {
                    container.innerHTML += `
                        <div class="cell-base" style="background:${entry.color.bg}; border: 1.5px solid ${entry.color.border}">
                            <div class="delete-btn no-print" onclick="deleteEntry('${slot.id}',${d})">âœ•</div>
                            <div class="course-card" style="color:${entry.color.text}">
                                <div class="c-name">${entry.name}</div>
                                <div class="c-room">${entry.room}</div>
                            </div>
                        </div>`;
                }
            }
        });
    }

    function saveEntry() {
        const name = document.getElementById("courseName").value.trim();
        const room = document.getElementById("roomName").value.trim() || "TBA";
        if (!name || currentSelectedDays.size === 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø§ØªÙ‡Ø§");

        const color = getColor(name);
        currentSelectedDays.forEach((slots, dayIdx) => {
            slots.forEach(slotId => {
                scheduleData = scheduleData.filter(x => !(x.day == dayIdx && x.slotId === slotId));
                scheduleData.push({ day: dayIdx, slotId, name, room, color });
            });
        });
        
        updateUI();
        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        document.getElementById("courseName").value = "";
        document.getElementById("roomName").value = "";
        currentSelectedDays.clear();
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
        renderConfigs();
    }

    function deleteEntry(sid, day) {
        scheduleData = scheduleData.filter(x => !(x.day == day && x.slotId === sid));
        updateUI();
    }

    function updateUI() {
        localStorage.setItem("ev_final_pro", JSON.stringify(scheduleData));
        renderTable();
    }

    function resetAll() { if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { localStorage.clear(); location.reload(); } }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù€ PDF Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© ---
    async function downloadPDF() {
        const element = document.getElementById('capture-area');
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
        const opt = {
            margin: [10, 5, 10, 5],
            filename: `Schedule_${new Date().getTime()}.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¸Ù‡Ø±
        document.body.classList.add('rendering');
        
        try {
            await html2pdf().set(opt).from(element).save();
        } catch (err) {
            console.error(err);
        } finally {
            document.body.classList.remove('rendering');
        }
    }

    // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
    renderTable();
</script>

</body>
</html>
